<?xml version="1.0" encoding="UTF-8"?>
<sequence name="GetInquiryTransactionSequence" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <log level="custom">
        <property expression="get-property('BankTransactionsIteratorSequence')" name="BankTransactionsIteratorSequenceLOG"/>
        <property expression="get-property('TransactionReference')" name="TransrefLog"/>
        <property expression="get-property('BankTransactionRef')" name="BankTransactionRefLog"/>
        <property expression="get-property('BankTransactionCompleted')" name="BankTransactionCompletedLog"/>
    </log>
    <!--  take all values form database  -->
    <dblookup>
        <connection>
            <pool>
                <driver>com.mysql.jdbc.Driver</driver>
                <url>jdbc:mysql://multi-groceries-db.cx5wkaagxbmx.eu-west-1.rds.amazonaws.com:3306/remitOne</url>
                <user>admin</user>
                <password>dobuy10014</password>
            </pool>
        </connection>
        <statement>
            <sql><![CDATA[
				 Select Value from Transaction_Credentials WHERE Application = "BAH" and App_key = "App_ID" 
				]]></sql>
            <result column="Value" name="App_ID"/>
        </statement>
        <statement>
            <sql><![CDATA[
			 Select Value from Transaction_Credentials WHERE Application = "BAH" and App_key = "APP_Password" 
			]]></sql>
            <result column="Value" name="APP_Password"/>
        </statement>
        <statement>
            <sql><![CDATA[ SELECT AcceptTransaction, BankTransactionRef FROM BankTransactions a where a.TransactionRef = ? and StatusDate in (Select max(StatusDate) from BankTransactions b where a.TransactionRef = b.TransactionRef group by b.TransactionRef);]]></sql>
            <parameter expression="get-property('TransactionRef')" type="VARCHAR"/>
            <result column="AcceptTransaction" name="AcceptTransaction"/>
            <result column="BankTransactionRef" name="BankTransactionRef"/>
        </statement>
    </dblookup>
    <log description="Account Title Fetch Body Logs" level="full" separator=",">
        <property expression="$body" name="ExtractedData"/>
    </log>
    <property name="messageType" scope="axis2" type="STRING" value="text/xml"/>
    <header description="Add XML Header" name="Content-Type" scope="transport" value="text/xml"/>
    <header name="SoapAction" scope="transport" value="http://tempuri.org/IService/GetInquiryTransaction"/>
    <payloadFactory media-type="xml">
        <format>
            <soapenv:Envelope xmlns:ns="http://schemas.datacontract.org/2004/07/" xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:tem="http://tempuri.org/">
                <soapenv:Header/>
                <soapenv:Body>
                    <tem:GetInquiryTransaction>
                        <tem:App_ID>$1</tem:App_ID>
                        <tem:APP_Password>$2</tem:APP_Password>
                        <tem:obj_UserCred>
                            <ns:AgentId>$3</ns:AgentId>
                            <ns:ReferenceNo>$4</ns:ReferenceNo>
                            <ns:Amount>$5</ns:Amount>
                            <ns:TieUpCode>$6</ns:TieUpCode>
                            <ns:UserId>$7</ns:UserId>
                            <ns:UserPassword>$8</ns:UserPassword>
                            <tem:CityID>$9</tem:CityID>
                        </tem:obj_UserCred>
                    </tem:GetInquiryTransaction>
                </soapenv:Body>
            </soapenv:Envelope>
        </format>
        <args>
            <arg evaluator="xml" expression="get-property('uri.var.App_ID')"/>
            <arg evaluator="xml" expression="get-property('uri.var.APP_Password')"/>
            <arg evaluator="xml" expression="get-property('uri.var.agentId')"/>
            <arg evaluator="xml" expression="get-property('uri.var.referenceno')"/>
            <arg evaluator="xml" expression="get-property('uri.var.amount')"/>
            <arg evaluator="xml" expression="get-property('uri.var.tieUpCode')"/>
            <arg evaluator="xml" expression="get-property('uri.var.userId')"/>
            <arg evaluator="xml" expression="get-property('uri.var.userPassword')"/>
            <arg evaluator="xml" expression="get-property('uri.var.cityid')"/>
        </args>
    </payloadFactory>
    <log level="full" separator=".">
        <property expression="$body" name="ResponseofPayload"/>
    </log>
    <property name="messageType" scope="axis2" type="STRING" value="application/json"/>
    <log description="TitleFetch Body Logs" level="full" separator=",">
        <property expression="$body" name="Incoming JSON Payload"/>
    </log>
    <property expression="$body" name="Incoming JSON Payload" scope="default" type="STRING"/>
    <header description="Add XML Header" name="Content-Type" scope="transport" value="application/json"/>
    <payloadFactory media-type="json">
        <format>
					{
					"App_ID": "$1",
					"APP_Password": "$2",
					"agent_code": "$3",
					"trans_ref":"$4",
					"send_amount": "$5",
					"TieUpCode": "$6",
					"agent_teller_userid": "$7",
					"UserPassword": "$8",
					"CityID":"$9"

					}

				</format>
        <args>
            <arg evaluator="json" expression="$.App_ID"/>
            <arg evaluator="json" expression="$.APP_Password"/>
            <arg evaluator="json" expression="$.AgentTransRef"/>
            <arg evaluator="json" expression="$.BankTransactionRef"/>
            <arg evaluator="json" expression="$.SendAmount"/>
            <arg value="TieUpCode"/>
            <arg evaluator="json" expression="$.AgentTellerUserId"/>
            <arg value="UserPassword"/>
            <arg value="CityID"/>
        </args>
    </payloadFactory>
    <log description="TransactionPRI Logs, Before End Point" level="full" separator=",">
        <property expression="$body" name="Transformed SOAP XML"/>
    </log>
    <send receive="UpdateStatusSequence">
        <endpoint key="GetInquiryTransacionEndpoint"/>
    </send>
</sequence>
